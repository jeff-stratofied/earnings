<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loan Portfolio â€” Earnings</title>

  <style>
    :root {
      --bg-light:#f8fafc;
      --bg-dark:#0F172A;
      --card-light:#ffffff;
      --card-dark:#1E293B;
      --border-light:rgba(15,23,42,0.07);
      --border-dark:#334155;
      --text-light:#0f172a;
      --text-dark:#E2E8F0;
      --accent:#0ea5e9;
      --bg:#f8fafc;
      --card:#ffffff;
      --border:rgba(15,23,42,0.07);
      --text:#0f172a;
      --muted:#64748b;
      --brand:#0ea5e9;
      --accent2:#7c3aed;
      --surface:#f1f5f9;
      --shadow:0 12px 30px rgba(15,23,42,0.06);
      --kpi-hover:translateY(-6px);
    }

    html[data-theme="dark"] {
      --bg:var(--bg-dark);
      --card:var(--card-dark);
      --border:var(--border-dark);
      --text:var(--text-dark);
      --muted:#9aa6b2;
      --surface:#020617;
    }

    body {
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,var(--surface) 0%, var(--card) 100%);
      background-color:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
    }

    .app {
      max-width:1200px;
      margin:20px auto;
      padding:16px;
    }

    header {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .header-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    h1 {
      font-size:20px;
      margin:0;
    }
    p.lead {
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .current-date {
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }

    .actions { display:flex; gap:8px; align-items:center }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.06);
      background:transparent;
      cursor:pointer;
      font-weight:600;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--brand),var(--accent2));
      color:white;
      border:none;
      box-shadow:var(--shadow);
    }
    .close-btn{
      background:#f1f5f9;
      border:none;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
    }

    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:14px 0 18px;
    }
    .kpi{
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(16,24,40,0.04);
      border:1px solid var(--border);
      cursor:pointer;
      transition:transform .18s ease, box-shadow .18s ease;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .kpi h3{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .kpi p{
      margin:8px 0 0;
      font-size:18px;
      font-weight:700;
    }
    .kpi:hover { transform:var(--kpi-hover); box-shadow:var(--shadow); }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      height:calc(100vh - 320px);
      overflow:auto;
      padding-right:6px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns:1fr; height:auto; }
      .kpis{ grid-template-columns:repeat(2,1fr); }
    }

    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px;
      border-radius:12px;
      background:var(--card);
      min-height:110px;
      cursor:pointer;
      overflow:hidden;
      transition:transform .18s ease, box-shadow .18s ease;
      border:1px solid var(--border);
    }
    .tile:hover{ transform:var(--kpi-hover); box-shadow:var(--shadow); }
    .tile-left{ flex:1; padding-right:10px; }
    .loan-name{ font-weight:700; font-size:14px; }
    .loan-sub{ font-size:12px; color:var(--muted); margin-top:6px; }
    .loan-meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); margin-top:8px; }

    .chart-wrap{
      width:170px;
      flex-shrink:0;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .mini-label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      text-align:right;
      width:100%;
    }

    /* Drawer */
    .drawer{
      position:fixed;
      right:0;
      top:0;
      height:100vh;
      max-width:1000px;
      width:760px;
      background:var(--card);
      box-shadow:-28px 0 80px rgba(2,6,23,0.14);
      transform:translateX(110%);
      transition:transform .32s cubic-bezier(.2,.9,.3,1), opacity .24s ease;
      z-index:120;
      overflow:auto;
      padding:20px;
      opacity:0;
    }
    .drawer.open{
      transform:translateX(0);
      opacity:1;
      animation:drawerIn .28s cubic-bezier(.2,.9,.3,1);
    }
    @keyframes drawerIn {
      from { transform:translateX(30%); opacity:0; }
      to   { transform:translateX(0);   opacity:1; }
    }

    .drawer-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .drawer-subtitle{
      color:var(--muted);
      font-size:13px;
      margin-top:4px;
    }
    .drawer-chart{
      width:100%;
      height:260px;
      background:linear-gradient(180deg,var(--card),#fcfeff);
      border-radius:8px;
      border:1px solid rgba(15,23,42,0.03);
      margin-bottom:8px;
      padding:0;
      position:relative;
      display:block;
    }

    .drawer-info-row{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      align-items:center;
    }
    .info-card{
      flex:1;
      background:var(--bg);
      padding:12px;
      border-radius:8px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      min-height:56px;
    }
    .info-card.small{ width:160px; align-items:flex-end; }
    .muted-small{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .main-val{ font-weight:800; font-size:18px; }
    .drawer-body{ display:flex; flex-direction:column; gap:12px; }
    .drawer-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .drawer-actions .spacer{ flex:1; }

    .amort-wrap{
      border:1px solid rgba(15,23,42,0.06);
      border-radius:8px;
      padding:8px;
      max-height:40vh;
      overflow:auto;
      background:var(--card);
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead th{
      position:sticky;
      top:0;
      background:var(--card);
      padding:8px;
      text-align:left;
      color:var(--muted);
      font-weight:700;
      border-bottom:1px solid rgba(15,23,42,0.06);
    }
    td{
      padding:8px;
      border-bottom:1px dashed rgba(15,23,42,0.06);
      text-align:right;
    }
    td:first-child, th:first-child{ text-align:left; }

    .tooltip{ position:fixed; z-index:999999;
      position:fixed;
      pointer-events:none;
      background:#0f172a;
      color:white;
      padding:6px 8px;
      border-radius:6px;
      font-size:12px;
      transform:translate(-50%,-120%);
      box-shadow:0 6px 18px rgba(2,6,23,0.2);
      display:none;
      z-index:9999;
      line-height:1.12;
    }
    .small{ font-size:12px; color:var(--muted); }

    @media(max-width:760px){
      .drawer{ width:100%; min-width:0; }
    }

    /* Theme toggle */
    .theme-icon{
      background:none;
      border:none;
      font-size:20px;
      cursor:pointer;
      transition:opacity .2s;
    }
    .theme-icon:hover{ opacity:0.7; }

  </style>
</head>
<body>
  <div class="app" role="main">
    <header>
      <div class="header-top">
        <div>
          <h1>Loan Portfolio â€” Earnings</h1>
          <p class="lead">Cumulative principal, interest, and fees, with stacked earnings visuals.</p>
          <div class="current-date">
            Current Month Index: <strong id="currentMonthLabel">18</strong>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-size:13px; color:var(--muted)">
            User: <strong style="color:var(--brand)">Jeff L Customer</strong>
          </div>
          <button id="themeToggle" class="theme-icon" title="Toggle dark mode">ðŸŒ™</button>
        </div>
      </div>
    </header>

    <section class="kpis" id="kpis"></section>
    <section class="grid" id="loanGrid" aria-live="polite"></section>
  </div>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="drawerTitle">Earnings Drawer</h2>
        <div class="muted-small" id="drawerSub">details</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn" id="closeBtn" aria-label="Close drawer">âœ•</button>
      </div>
    </div>

    <div class="drawer-info-row">
      <div class="info-card" id="drawerPrimaryCard">
        <div class="muted-small" id="drawerPrimaryTitle">Net Earnings</div>
        <div id="drawerPrimary" class="main-val"></div>
      </div>
      <div class="info-card small" id="drawerSecondaryCard">
        <div class="muted-small" id="drawerSecondaryTitle">Total Fees</div>
        <div id="drawerSecondary" class="main-val small"></div>
      </div>
    </div>

    <div id="drawerBody">
      <div class="drawer-chart" id="drawerChartArea"></div>
      <div id="drawerExtra"></div>
    </div>
  </aside>

  <!-- KPI Drawers -->
  <aside id="kpiDrawer1" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi1Title">KPI 1</h2>
        <div id="kpi1Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer1" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi1PrimaryTitle"></div>
        <div id="kpi1Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi1SecondaryTitle"></div>
        <div id="kpi1Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi1Chart"></div>
      <div class="amort-wrap" id="kpi1Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer1">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
  </aside>

  <aside id="kpiDrawer2" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi2Title">KPI 2</h2>
        <div id="kpi2Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer2" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi2PrimaryTitle"></div>
        <div id="kpi2Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi2SecondaryTitle"></div>
        <div id="kpi2Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi2Chart"></div>
      <div class="amort-wrap" id="kpi2Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer2">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
  </aside>

  <aside id="kpiDrawer3" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi3Title">KPI 3</h2>
        <div id="kpi3Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer3" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi3PrimaryTitle"></div>
        <div id="kpi3Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi3SecondaryTitle"></div>
        <div id="kpi3Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi3Chart"></div>
      <div class="amort-wrap" id="kpi3Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer3">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
  </aside>

  <aside id="kpiDrawer4" class="drawer kpi-drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <h2 id="kpi4Title">KPI 4</h2>
        <div id="kpi4Sub" class="drawer-subtitle"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="close-btn kpi-close" data-kpi-close="kpiDrawer4" aria-label="Close KPI drawer">âœ•</button>
      </div>
    </div>
    <div class="drawer-info-row">
      <div class="info-card">
        <div class="muted-small" id="kpi4PrimaryTitle"></div>
        <div id="kpi4Primary" class="main-val"></div>
      </div>
      <div class="info-card small">
        <div class="muted-small" id="kpi4SecondaryTitle"></div>
        <div id="kpi4Secondary" class="main-val small"></div>
      </div>
    </div>
    <div class="drawer-body">
      <div class="drawer-chart" id="kpi4Chart"></div>
      <div class="amort-wrap" id="kpi4Table"></div>
    </div>
    <div class="drawer-actions">
      <button class="btn" data-kpi-close="kpiDrawer4">Close</button>
      <div class="spacer"></div>
      <button class="btn primary">Export</button>
    </div>
  </aside>

  <script>
    // --------------------------
    // Settings & base data
    // --------------------------
    const CURRENT_MONTH = 18; // keep in sync with ROI page if you want
    document.getElementById("currentMonthLabel").textContent = CURRENT_MONTH;

    // Loan metadata: same as ROI, with feePerMonth added.
    // TODO: Update feePerMonth values from Earnings.xlsx N1:T11 (col T).
    const loans = [
      { id:1,  purchaseDate:'2024-01-01', purchasePrice:7000,  termYears:10, graceYears:0.83, nominalRate:0.0883, feePerMonth:3.00 },
      { id:2,  purchaseDate:'2024-02-01', purchasePrice:7500,  termYears:8,  graceYears:2.00, nominalRate:0.0750, feePerMonth:3.00 },
      { id:3,  purchaseDate:'2024-03-01', purchasePrice:12000, termYears:12, graceYears:3.00, nominalRate:0.0825, feePerMonth:3.00 },
      { id:4,  purchaseDate:'2024-04-01', purchasePrice:6000,  termYears:9,  graceYears:1.50, nominalRate:0.0950, feePerMonth:3.00 },
      { id:5,  purchaseDate:'2024-07-01', purchasePrice:5000,  termYears:10, graceYears:1.00, nominalRate:0.0900, feePerMonth:3.00 },
      { id:6,  purchaseDate:'2025-01-01', purchasePrice:7500,  termYears:5,  graceYears:0.00, nominalRate:0.0730, feePerMonth:3.00 },
      { id:7,  purchaseDate:'2025-06-01', purchasePrice:10000, termYears:8,  graceYears:0.00, nominalRate:0.0900, feePerMonth:3.00 },
      { id:8,  purchaseDate:'2025-10-01', purchasePrice:5000,  termYears:9,  graceYears:0.50, nominalRate:0.1100, feePerMonth:3.00 },
      { id:9,  purchaseDate:'2025-02-01', purchasePrice:10000, termYears:7,  graceYears:0.25, nominalRate:0.1000, feePerMonth:3.00 },
      { id:10, purchaseDate:'2025-03-01', purchasePrice:8000,  termYears:3,  graceYears:0.00, nominalRate:0.0600, feePerMonth:3.00 }
    ];

    // --------------------------
    // Amortization + earnings
    // --------------------------
    function calcAmort(principal, annualRate, termYears, graceYears){
      const monthlyRate = annualRate / 12;
      const totalMonths = Math.round(termYears * 12);
      const graceMonths = Math.round(graceYears * 12);
      const repayMonths = Math.max(1, totalMonths - graceMonths);
      let balance = principal;
      const schedule = [];

      // grace period: interest only
      for(let m=1; m<=graceMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        balance = +(balance + interest).toFixed(2);
        schedule.push({
          monthIndex:m,
          payment:0,
          principalPaid:0,
          interest,
          balance
        });
      }

      // repayment period
      const payment = monthlyRate === 0
        ? +(balance / repayMonths).toFixed(2)
        : +((balance * monthlyRate) / (1 - Math.pow(1+monthlyRate, -repayMonths))).toFixed(2);

      for(let m=1; m<=repayMonths; m++){
        const interest = +(balance * monthlyRate).toFixed(2);
        const principalPaid = +Math.min(balance, +(payment - interest).toFixed(2));
        balance = +(Math.max(0, balance - principalPaid).toFixed(2));
        schedule.push({
          monthIndex: graceMonths + m,
          payment:+payment.toFixed(2),
          principalPaid,
          interest,
          balance
        });
      }
      return { payment, schedule };
    }

    const loansWithEarnings = loans.map(l => {
      const amort = calcAmort(l.purchasePrice, l.nominalRate, l.termYears, l.graceYears);
      let cumP = 0, cumI = 0;
      const earningsSchedule = amort.schedule.map(row => {
        cumP = +(cumP + row.principalPaid).toFixed(2);
        cumI = +(cumI + row.interest).toFixed(2);
        const m = row.monthIndex;
        const cumFees = +(l.feePerMonth * m).toFixed(2);  // cumulative flat monthly fees
        const netEarnings = +(cumP + cumI - cumFees).toFixed(2);
        return {
          monthIndex:m,
          payment:row.payment,
          principalPaid:row.principalPaid,
          interest:row.interest,
          balance:row.balance,
          cumPrincipal:cumP,
          cumInterest:cumI,
          cumFees:cumFees,
          netEarnings:netEarnings
        };
      });
      return { ...l, amort, earningsSchedule };
    });

    // --------------------------
    // KPI calculations
    // --------------------------
    function computeEarningsKPIs(list){
      let totalNetToDate = 0;
      let totalNetProjected = 0;
      let totalFeesToDate = 0;
      let totalPrincipal = 0;

      list.forEach(l => {
        const lastIdx = l.earningsSchedule.length - 1;
        const atCurrent = l.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || l.earningsSchedule[lastIdx];
        const atEnd = l.earningsSchedule[lastIdx];

        totalNetToDate += atCurrent.netEarnings;
        totalFeesToDate += atCurrent.cumFees;
        totalNetProjected += atEnd.netEarnings;
        totalPrincipal += l.purchasePrice;
      });

      const avgMonthlyEarnings = CURRENT_MONTH > 0 ? totalNetToDate / CURRENT_MONTH : 0;

      return {
        totalNetToDate,
        totalNetProjected,
        totalFeesToDate,
        avgMonthlyEarnings
      };
    }

    const kpis = computeEarningsKPIs(loansWithEarnings);
    const totalPrincipal = loans.reduce((s,l)=>s+l.purchasePrice,0);

    // --------------------------
    // Mini stacked earnings chart (per tile)
    // --------------------------
    
    // --------------------------
    // Mini stacked earnings chart (per tile)
    // --------------------------
    function createMiniStackedEarningsSVG(containerEl, earningsSchedule){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const w = 170;
      const h = 48;
      const padL = 4, padR = 4, padT = 4, padB = 4;

      const data = earningsSchedule; // full life of loan

      // compute pos/neg ranges using negative fees
      let maxAbs = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees; // negative
        maxAbs = Math.max(maxAbs, pos, Math.abs(neg));
      });
      if(maxAbs <= 0) maxAbs = 1;

      const yZero = h/2;
      const halfHeight = (h - padT - padB) / 2;
      const scale = halfHeight / maxAbs;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","48");

      // zero axis
      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke","#cbd5e1");
      axis.setAttribute("stroke-width","0.8");
      svg.appendChild(axis);

      data.forEach((d, i) => {
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const negFees = -d.cumFees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = Math.abs(negFees) * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        const barWidth = Math.max(1, barW-2);

        // principal (top)
        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+1);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", barWidth);
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill", "#0ea5e9");

        // interest (middle)
        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+1);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", barWidth);
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill", "#22c55e");

        // fees (negative, below axis)
        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+1);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", barWidth);
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill", "#ef4444");

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);
      });

      // vertical dotted current-month marker
      const currentX = padL + (CURRENT_MONTH - 1) * barW;
      const vline = document.createElementNS(svgNS, "line");
      vline.setAttribute("x1", currentX);
      vline.setAttribute("x2", currentX);
      vline.setAttribute("y1", 0);
      vline.setAttribute("y2", h);
      vline.setAttribute("stroke", "#64748b");
      vline.setAttribute("stroke-dasharray", "4,3");
      vline.setAttribute("stroke-width", "1");
      svg.appendChild(vline);

      containerEl.appendChild(svg);
    }


    // --------------------------
    // Drawer stacked chart (larger)
    // --------------------------
    
    // --------------------------
    // Drawer stacked chart (larger)
    // --------------------------
    function createDrawerStackedChart(containerEl, earningsSchedule){
      containerEl.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      const rect = containerEl.getBoundingClientRect();
      const w = Math.max(360, rect.width || 700);
      const h = 260;
      const padL = 50, padR = 20, padT = 20, padB = 40;

      const data = earningsSchedule;

      // find extrema using negative fees
      let maxAbs = 0;
      data.forEach(d => {
        const pos = d.cumPrincipal + d.cumInterest;
        const neg = -d.cumFees;
        maxAbs = Math.max(maxAbs, pos, Math.abs(neg));
      });
      if(maxAbs <= 0) maxAbs = 1;

      const yZero = padT + (h - padT - padB) / 2;
      const halfHeight = (h - padT - padB) / 2;
      const scale = halfHeight / maxAbs;

      const count = data.length;
      const barW = (w - padL - padR) / Math.max(1, count);

      const svg = document.createElementNS(svgNS,"svg");
      svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","100%");

      // grid lines / labels
      for(let i=0;i<=4;i++){
        const v = maxAbs * (1 - i/4);
        const yUp = yZero - v*scale;
        const yDn = yZero + v*scale;

        const upLine = document.createElementNS(svgNS,"line");
        upLine.setAttribute("x1",padL);
        upLine.setAttribute("x2",w-padR);
        upLine.setAttribute("y1",yUp);
        upLine.setAttribute("y2",yUp);
        upLine.setAttribute("stroke","rgba(148,163,184,0.35)");
        upLine.setAttribute("stroke-width","0.7");
        svg.appendChild(upLine);

        const dnLine = document.createElementNS(svgNS,"line");
        dnLine.setAttribute("x1",padL);
        dnLine.setAttribute("x2",w-padR);
        dnLine.setAttribute("y1",yDn);
        dnLine.setAttribute("y2",yDn);
        dnLine.setAttribute("stroke","rgba(148,163,184,0.12)");
        dnLine.setAttribute("stroke-width","0.7");
        svg.appendChild(dnLine);

        const lbl = document.createElementNS(svgNS,"text");
        lbl.textContent = "$" + Math.round(v).toLocaleString();
        lbl.setAttribute("x", padL - 10);
        lbl.setAttribute("y", yUp + 4);
        lbl.setAttribute("font-size","11");
        lbl.setAttribute("fill","var(--text)");
        lbl.setAttribute("text-anchor","end");
        svg.appendChild(lbl);
      }

      // zero axis
      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1",padL);
      axis.setAttribute("x2",w-padR);
      axis.setAttribute("y1",yZero);
      axis.setAttribute("y2",yZero);
      axis.setAttribute("stroke","#94a3b8");
      axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);

      const hoverG = document.createElementNS(svgNS,"g");
      hoverG.setAttribute("opacity","0");

      const tipBg = document.createElementNS(svgNS,"rect");
      tipBg.setAttribute("rx", 6);
      tipBg.setAttribute("fill","black");
      tipBg.setAttribute("opacity","0.83");

      const tipText1 = document.createElementNS(svgNS,"text");
      tipText1.setAttribute("fill","white");
      tipText1.setAttribute("font-size","11");
      tipText1.setAttribute("text-anchor","middle");

      const tipText2 = document.createElementNS(svgNS,"text");
      tipText2.setAttribute("fill","white");
      tipText2.setAttribute("font-size","10");
      tipText2.setAttribute("text-anchor","middle");

      hoverG.appendChild(tipBg);
      hoverG.appendChild(tipText1);
      hoverG.appendChild(tipText2);

      const hoverState = {
        visible:false,
        targetX:0,
        targetY:0,
        currentX:0,
        currentY:0,
        raf:null
      };

      function updateTooltipPosition(x, y){
        tipBg.setAttribute("x", x - 70);
        tipBg.setAttribute("y", y - 46);
        tipBg.setAttribute("width", 140);
        tipBg.setAttribute("height", 40);

        tipText1.setAttribute("x", x);
        tipText1.setAttribute("y", y - 30);

        tipText2.setAttribute("x", x);
        tipText2.setAttribute("y", y - 16);
      }

      function animateHover(){
        hoverState.currentX += (hoverState.targetX - hoverState.currentX) * 0.18;
        hoverState.currentY += (hoverState.targetY - hoverState.currentY) * 0.18;

        updateTooltipPosition(hoverState.currentX, hoverState.currentY);

        if(hoverState.visible){
          hoverState.raf = requestAnimationFrame(animateHover);
        } else {
          hoverState.raf = null;
        }
      }

      function showHover(x, y, d){
        tipText1.textContent = `M${d.monthIndex} Net: $${d.netEarnings.toFixed(2)}`;
        tipText2.textContent = `P:$${d.cumPrincipal.toFixed(0)} I:$${d.cumInterest.toFixed(0)} F:-$${d.cumFees.toFixed(0)}`;

        hoverState.targetX = x;
        hoverState.targetY = y;
        if(!hoverState.visible){
          hoverState.currentX = x;
          hoverState.currentY = y;
        }
        hoverState.visible = true;
        hoverG.setAttribute("opacity","1");

        if(!hoverState.raf){
          hoverState.raf = requestAnimationFrame(animateHover);
        }
      }

      function hideHover(){
        hoverState.visible = false;
        hoverG.setAttribute("opacity","0");
      }

      data.forEach((d, i) => {
        const x = padL + i*barW;

        const principal = d.cumPrincipal;
        const interest = d.cumInterest;
        const negFees = -d.cumFees;

        const hPrin = principal * scale;
        const hInt  = interest  * scale;
        const hFees = Math.abs(negFees) * scale;

        const yInt  = yZero - hInt;
        const yPrin = yZero - hInt - hPrin;
        const yFee  = yZero;

        const barWidth = Math.max(2, barW-4);

        const rPrin = document.createElementNS(svgNS,"rect");
        rPrin.setAttribute("x", x+2);
        rPrin.setAttribute("y", yPrin);
        rPrin.setAttribute("width", barWidth);
        rPrin.setAttribute("height", hPrin);
        rPrin.setAttribute("fill","#0ea5e9");

        const rInt = document.createElementNS(svgNS,"rect");
        rInt.setAttribute("x", x+2);
        rInt.setAttribute("y", yInt);
        rInt.setAttribute("width", barWidth);
        rInt.setAttribute("height", hInt);
        rInt.setAttribute("fill","#22c55e");

        const rFee = document.createElementNS(svgNS,"rect");
        rFee.setAttribute("x", x+2);
        rFee.setAttribute("y", yFee);
        rFee.setAttribute("width", barWidth);
        rFee.setAttribute("height", hFees);
        rFee.setAttribute("fill","#ef4444");

        // smooth hover tooltip
        [rPrin,rInt,rFee].forEach(el=>{
          el.addEventListener("mousemove", ev=>{
            const rectSvg = svg.getBoundingClientRect();
            const cx = ev.clientX - rectSvg.left;
            const cy = ev.clientY - rectSvg.top;

            showHover(cx, cy, d);
          });

          el.addEventListener("mouseleave", hideHover);
        });

        svg.appendChild(rPrin);
        svg.appendChild(rInt);
        svg.appendChild(rFee);

        // x-axis labels (every 12 months)
        if((d.monthIndex % 12) === 0 || d.monthIndex === 1){
          const lbl = document.createElementNS(svgNS,"text");
          lbl.textContent = "M"+d.monthIndex;
          lbl.setAttribute("x", x+barWidth/2);
          lbl.setAttribute("y", h-padB+16);
          lbl.setAttribute("font-size","11");
          lbl.setAttribute("fill","var(--text)");
          lbl.setAttribute("text-anchor","middle");
          svg.appendChild(lbl);
        }
      });

      // add hover group last so it is on top of bars
      svg.appendChild(hoverG);

      // vertical dotted current-month marker
      const currentX = padL + (CURRENT_MONTH - 1) * barW;
      const vline = document.createElementNS(svgNS, "line");
      vline.setAttribute("x1", currentX);
      vline.setAttribute("x2", currentX);
      vline.setAttribute("y1", 0);
      vline.setAttribute("y2", h);
      vline.setAttribute("stroke", "#64748b");
      vline.setAttribute("stroke-dasharray", "4,3");
      vline.setAttribute("stroke-width", "1");
      svg.appendChild(vline);

      containerEl.appendChild(svg);
    }
    // --------------------------
    // Render KPI tiles
    // --------------------------
    const kpisEl = document.getElementById("kpis");
    kpisEl.innerHTML = `
      <div class="kpi" data-kpi="netToDate">
        <h3>Total Net Earnings to Date</h3>
        <p id="kpiNetToDate">$${kpis.totalNetToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
      <div class="kpi" data-kpi="projected">
        <h3>Projected Lifetime Earnings</h3>
        <p id="kpiNetProj">$${kpis.totalNetProjected.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
      <div class="kpi" data-kpi="avgMonthly">
        <h3>Average Monthly Earnings</h3>
        <p id="kpiAvgMonth">$${kpis.avgMonthlyEarnings.toFixed(2)}</p>
      </div>
      <div class="kpi" data-kpi="fees">
        <h3>Total Fees to Date</h3>
        <p id="kpiFees">$${kpis.totalFeesToDate.toLocaleString(undefined,{maximumFractionDigits:0})}</p>
      </div>
    `;

    // --------------------------
    // KPI drawers
    // --------------------------
    const kpiDrawerRefs = {
      netToDate:{
        drawer:document.getElementById("kpiDrawer1"),
        title:document.getElementById("kpi1Title"),
        sub:document.getElementById("kpi1Sub"),
        primaryTitle:document.getElementById("kpi1PrimaryTitle"),
        primaryVal:document.getElementById("kpi1Primary"),
        secondaryTitle:document.getElementById("kpi1SecondaryTitle"),
        secondaryVal:document.getElementById("kpi1Secondary"),
        chart:document.getElementById("kpi1Chart"),
        table:document.getElementById("kpi1Table"),
        chartRender:renderKPI1Chart,
        tableRender:renderKPI1Table
      },
      projected:{
        drawer:document.getElementById("kpiDrawer2"),
        title:document.getElementById("kpi2Title"),
        sub:document.getElementById("kpi2Sub"),
        primaryTitle:document.getElementById("kpi2PrimaryTitle"),
        primaryVal:document.getElementById("kpi2Primary"),
        secondaryTitle:document.getElementById("kpi2SecondaryTitle"),
        secondaryVal:document.getElementById("kpi2Secondary"),
        chart:document.getElementById("kpi2Chart"),
        table:document.getElementById("kpi2Table"),
        chartRender:renderKPI2Chart,
        tableRender:renderKPI2Table
      },
      avgMonthly:{
        drawer:document.getElementById("kpiDrawer3"),
        title:document.getElementById("kpi3Title"),
        sub:document.getElementById("kpi3Sub"),
        primaryTitle:document.getElementById("kpi3PrimaryTitle"),
        primaryVal:document.getElementById("kpi3Primary"),
        secondaryTitle:document.getElementById("kpi3SecondaryTitle"),
        secondaryVal:document.getElementById("kpi3Secondary"),
        chart:document.getElementById("kpi3Chart"),
        table:document.getElementById("kpi3Table"),
        chartRender:renderKPI3Chart,
        tableRender:renderKPI3Table
      },
      fees:{
        drawer:document.getElementById("kpiDrawer4"),
        title:document.getElementById("kpi4Title"),
        sub:document.getElementById("kpi4Sub"),
        primaryTitle:document.getElementById("kpi4PrimaryTitle"),
        primaryVal:document.getElementById("kpi4Primary"),
        secondaryTitle:document.getElementById("kpi4SecondaryTitle"),
        secondaryVal:document.getElementById("kpi4Secondary"),
        chart:document.getElementById("kpi4Chart"),
        table:document.getElementById("kpi4Table"),
        chartRender:renderKPI4Chart,
        tableRender:renderKPI4Table
      }
    };

    function resetKpiDrawerContent(ref){
      ref.chart.innerHTML = "";
      ref.table.innerHTML = "";
    }

    function closeAllKpiDrawers(){
      Object.values(kpiDrawerRefs).forEach(ref => {
        ref.drawer.classList.remove("open");
        ref.drawer.setAttribute("aria-hidden","true");
      });
    }

    function openKpiDrawer(ref){
      closeAllKpiDrawers();
      ref.drawer.classList.add("open");
      ref.drawer.setAttribute("aria-hidden","false");
      ref.drawer.scrollTop = 0;
    }

    function openKpi1(){
      const ref = kpiDrawerRefs.netToDate;
      ref.title.textContent = "Total Net Earnings to Date";
      ref.sub.textContent = "Portfolio-level earnings across all loans.";
      ref.primaryTitle.textContent = "Net Earnings to Date";
      ref.primaryVal.textContent = `$${kpis.totalNetToDate.toFixed(2)}`;
      ref.secondaryTitle.textContent = "Total Fees to Date";
      ref.secondaryVal.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
      resetKpiDrawerContent(ref);
      ref.chartRender(loansWithEarnings);
      ref.tableRender(loansWithEarnings);
      openKpiDrawer(ref);
    }

    function openKpi2(){
      const ref = kpiDrawerRefs.projected;
      ref.title.textContent = "Projected Lifetime Earnings";
      ref.sub.textContent = "Net earnings at maturity for all loans.";
      ref.primaryTitle.textContent = "Projected Lifetime Net";
      ref.primaryVal.textContent = `$${kpis.totalNetProjected.toFixed(2)}`;
      ref.secondaryTitle.textContent = "Total Principal";
      ref.secondaryVal.textContent = `$${totalPrincipal.toLocaleString()}`;
      resetKpiDrawerContent(ref);
      ref.chartRender(loansWithEarnings);
      ref.tableRender(loansWithEarnings);
      openKpiDrawer(ref);
    }

    function openKpi3(){
      const ref = kpiDrawerRefs.avgMonthly;
      ref.title.textContent = "Average Monthly Earnings";
      ref.sub.textContent = `Based on net earnings through month ${CURRENT_MONTH}.`;
      ref.primaryTitle.textContent = "Avg Monthly Earnings";
      ref.primaryVal.textContent = `$${kpis.avgMonthlyEarnings.toFixed(2)}`;
      ref.secondaryTitle.textContent = "Months Counted";
      ref.secondaryVal.textContent = `${CURRENT_MONTH} months`;
      resetKpiDrawerContent(ref);
      ref.chartRender(loansWithEarnings);
      ref.tableRender(loansWithEarnings);
      openKpiDrawer(ref);
    }

    function openKpi4(){
      const ref = kpiDrawerRefs.fees;
      ref.title.textContent = "Total Fees to Date";
      ref.sub.textContent = "Cumulative monthly fees across all loans.";
      ref.primaryTitle.textContent = "Total Fees";
      ref.primaryVal.textContent = `$${kpis.totalFeesToDate.toFixed(2)}`;
      ref.secondaryTitle.textContent = "Total Loans";
      ref.secondaryVal.textContent = `${loans.length}`;
      resetKpiDrawerContent(ref);
      ref.chartRender(loansWithEarnings);
      ref.tableRender(loansWithEarnings);
      openKpiDrawer(ref);
    }

    document.querySelectorAll("[data-kpi-close]").forEach(btn => {
      btn.addEventListener("click", () => {
        closeAllKpiDrawers();
      });
    });

    document.addEventListener("keydown", e => {
      if(e.key === "Escape") closeAllKpiDrawers();
    });

    document.addEventListener("click", e => {
      const openRef = Object.values(kpiDrawerRefs).find(ref => ref.drawer.classList.contains("open"));
      if(openRef){
        const inside = openRef.drawer.contains(e.target);
        const tileClicked = e.target.closest(".kpi");
        if(!inside && !tileClicked){
          closeAllKpiDrawers();
        }
      }
    });

    // --------------------------
    // Loan tiles
    // --------------------------
    const grid = document.getElementById("loanGrid");
    const drawer = document.getElementById("drawer");
    const drawerTitle = document.getElementById("drawerTitle");
    const drawerSub = document.getElementById("drawerSub");
    const drawerPrimaryTitle = document.getElementById("drawerPrimaryTitle");
    const drawerPrimary = document.getElementById("drawerPrimary");
    const drawerSecondaryTitle = document.getElementById("drawerSecondaryTitle");
    const drawerSecondary = document.getElementById("drawerSecondary");
    const drawerChartArea = document.getElementById("drawerChartArea");
    const drawerExtra = document.getElementById("drawerExtra");

    let currentLoan = null;

    loansWithEarnings.forEach(loan => {
      const lastIdx = loan.earningsSchedule.length - 1;
      const atCurrent = loan.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || loan.earningsSchedule[lastIdx];

      const tile = document.createElement("div");
      tile.className = "tile";
      tile.setAttribute("tabindex","0");
      tile.innerHTML = `
        <div class="tile-left">
          <div class="loan-name">Loan ${loan.id}</div>
          <div class="loan-sub">$${loan.purchasePrice.toLocaleString()}</div>
          <div class="loan-meta">
            <div>Term: ${loan.termYears}y</div>
            <div>Grace: ${loan.graceYears}y</div>
            <div>Fee: $${loan.feePerMonth.toFixed(2)}/mo</div>
          </div>
        </div>
        <div class="chart-wrap">
          <div class="mini-label">
            Net Earnings M${CURRENT_MONTH}: $${atCurrent.netEarnings.toFixed(0)}
          </div>
          <div class="mini-chart"></div>
        </div>
      `;

      tile.addEventListener("click", e => {
        e.stopPropagation();
        openLoanDrawer(loan);
      });
      tile.addEventListener("keydown", e => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          openLoanDrawer(loan);
        }
      });

      grid.appendChild(tile);

      const miniChartContainer = tile.querySelector(".mini-chart");
      createMiniStackedEarningsSVG(miniChartContainer, loan.earningsSchedule);
    });

    // --------------------------
    // Drawer behavior
    // --------------------------
    document.getElementById("closeBtn").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", e => {
      if(e.key === "Escape") closeDrawer();
    });
    document.addEventListener("click", e => {
      if(drawer.classList.contains("open")){
        const inside = drawer.contains(e.target);
        const tileClicked = e.target.closest(".tile");
        if(!inside && !tileClicked){
          closeDrawer();
        }
      }
    });

    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true");
      currentLoan = null;
    }

    function openLoanDrawer(loan){
      currentLoan = loan;
      const lastIdx = loan.earningsSchedule.length - 1;
      const atCurrent = loan.earningsSchedule[Math.min(CURRENT_MONTH-1, lastIdx)] || loan.earningsSchedule[lastIdx];
      const atEnd = loan.earningsSchedule[lastIdx];

      drawerTitle.textContent = `Loan ${loan.id} â€” Earnings`;
      drawerSub.textContent = `Purchase: ${loan.purchaseDate} â€¢ Principal $${loan.purchasePrice.toLocaleString()}`;
      drawerPrimaryTitle.textContent = "Net Earnings to Date";
      drawerPrimary.textContent = `$${atCurrent.netEarnings.toFixed(2)}`;
      drawerSecondaryTitle.textContent = "Fees to Date";
      drawerSecondary.textContent = `$${atCurrent.cumFees.toFixed(2)}`;

      createDrawerStackedChart(drawerChartArea, loan.earningsSchedule);

      // table
      let rowsHtml = "";
      loan.earningsSchedule.forEach(r => {
        rowsHtml += `
          <tr>
            <td>${r.monthIndex}</td>
            <td>$${r.cumPrincipal.toFixed(2)}</td>
            <td>$${r.cumInterest.toFixed(2)}</td>
            <td>-$${r.cumFees.toFixed(2)}</td>
            <td>$${r.netEarnings.toFixed(2)}</td>
          </tr>
        `;
      });

      drawerExtra.innerHTML = `
        <h3 style="margin-top:12px;margin-bottom:8px;">Earnings Breakdown by Month</h3>
        <div class="amort-wrap">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Cumulative Principal</th>
                <th>Cumulative Interest</th>
                <th>Cumulative Fees</th>
                <th>Net Earnings</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;

      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden","false");
      drawer.scrollTop = 0;
    }

    // --------------------------
    // KPI click wiring
    // --------------------------
    const kpiOpeners = {
      netToDate:openKpi1,
      projected:openKpi2,
      avgMonthly:openKpi3,
      fees:openKpi4
    };

    document.querySelectorAll(".kpi").forEach(k => {
      k.addEventListener("click", () => {
        const key = k.getAttribute("data-kpi");
        if(kpiOpeners[key]){
          closeDrawer();
          kpiOpeners[key]();
        }
      });
    });

    // --------------------------
    // Theme toggle
    // --------------------------
    const themeToggleBtn = document.getElementById("themeToggle");
    const root = document.documentElement;

    function setTheme(mode){
      root.setAttribute("data-theme", mode);
      if(mode === "dark"){
        themeToggleBtn.textContent = "â˜€ï¸";
      } else {
        themeToggleBtn.textContent = "ðŸŒ™";
      }
      try { localStorage.setItem("earningsTheme", mode); } catch(e){}
    }

    const stored = (()=>{ try { return localStorage.getItem("earningsTheme"); } catch(e){ return null; }})();
    if(stored === "dark" || (!stored && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches)){
      setTheme("dark");
    } else {
      setTheme("light");
    }

    themeToggleBtn.addEventListener("click", () => {
      const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
      setTheme(current === "dark" ? "light" : "dark");
    });

    // ======================
    // KPI CHART RENDERERS
    // ======================
    function buildKpiChart(containerId, data){
      const container = document.getElementById(containerId);
      if(!container) return;
      container.innerHTML = "";

      const svgNS = "http://www.w3.org/2000/svg";
      const width = container.clientWidth || 720;
      const height = container.clientHeight || 260;
      const pad = { left:24, right:16, top:16, bottom:28 };

      const maxMonths = Math.max(CURRENT_MONTH, ...data.map(l => l.earningsSchedule.length));
      const series = Array.from({length:maxMonths}, (_,i)=>{
        let total = 0;
        data.forEach(l => {
          const row = l.earningsSchedule[Math.min(i, l.earningsSchedule.length-1)];
          if(row) total += row.netEarnings;
        });
        return { month:i+1, total };
      });

      const maxVal = Math.max(...series.map(s=>s.total), 1);
      const minVal = Math.min(...series.map(s=>s.total), 0);
      const yRange = Math.max(maxVal - minVal, 1);

      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
      svg.setAttribute("width","100%");
      svg.setAttribute("height","100%");

      const path = document.createElementNS(svgNS, "path");
      let d = "";
      series.forEach((pt, idx) => {
        const x = pad.left + (idx/(maxMonths-1 || 1)) * (width - pad.left - pad.right);
        const y = pad.top + (1 - (pt.total - minVal) / yRange) * (height - pad.top - pad.bottom);
        d += idx === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`;
      });
      path.setAttribute("d", d);
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "url(#kpiGradient)");
      path.setAttribute("stroke-width", "2.5");

      const defs = document.createElementNS(svgNS,"defs");
      const grad = document.createElementNS(svgNS,"linearGradient");
      grad.setAttribute("id","kpiGradient");
      grad.setAttribute("x1","0%");
      grad.setAttribute("x2","100%");
      grad.setAttribute("y1","0%");
      grad.setAttribute("y2","0%");
      const stop1 = document.createElementNS(svgNS,"stop");
      stop1.setAttribute("offset","0%");
      stop1.setAttribute("stop-color","#0ea5e9");
      const stop2 = document.createElementNS(svgNS,"stop");
      stop2.setAttribute("offset","100%");
      stop2.setAttribute("stop-color","#7c3aed");
      grad.appendChild(stop1);
      grad.appendChild(stop2);
      defs.appendChild(grad);
      svg.appendChild(defs);

      const axis = document.createElementNS(svgNS,"line");
      axis.setAttribute("x1", pad.left);
      axis.setAttribute("x2", width - pad.right);
      axis.setAttribute("y1", height - pad.bottom);
      axis.setAttribute("y2", height - pad.bottom);
      axis.setAttribute("stroke", "var(--border)");
      axis.setAttribute("stroke-width", "1");

      const currentX = pad.left + ((Math.min(CURRENT_MONTH, maxMonths)-1)/(maxMonths-1 || 1)) * (width - pad.left - pad.right);
      const vline = document.createElementNS(svgNS, "line");
      vline.setAttribute("x1", currentX);
      vline.setAttribute("x2", currentX);
      vline.setAttribute("y1", pad.top);
      vline.setAttribute("y2", height - pad.bottom);
      vline.setAttribute("stroke", "#64748b");
      vline.setAttribute("stroke-dasharray", "4,3");
      vline.setAttribute("stroke-width", "1.5");

      svg.appendChild(axis);
      svg.appendChild(path);
      svg.appendChild(vline);
      container.appendChild(svg);
    }

    function renderKPI1Chart(data){
      buildKpiChart("kpi1Chart", data);
    }
    function renderKPI2Chart(data){
      buildKpiChart("kpi2Chart", data);
    }
    function renderKPI3Chart(data){
      buildKpiChart("kpi3Chart", data);
    }
    function renderKPI4Chart(data){
      buildKpiChart("kpi4Chart", data);
    }

    // ======================
    // KPI TABLE RENDERERS
    // ======================
    function renderKpiTable(containerId, headers, rows){
      const container = document.getElementById(containerId);
      if(!container) return;
      const headHtml = headers.map(h=>`<th>${h}</th>`).join("");
      const bodyHtml = rows.map(r=>`<tr>${r.map(cell=>`<td>${cell}</td>`).join("")}</tr>`).join("");
      container.innerHTML = `
        <table>
          <thead><tr>${headHtml}</tr></thead>
          <tbody>${bodyHtml}</tbody>
        </table>
      `;
    }

    function renderKPI1Table(data){
      const rows = data.map(l => {
        const lastIdx = l.earningsSchedule.length-1;
        const atCur = l.earningsSchedule[Math.min(CURRENT_MONTH-1,lastIdx)] || l.earningsSchedule[lastIdx];
        return [
          `Loan ${l.id}`,
          `$${atCur.netEarnings.toFixed(2)}`,
          `$${atCur.cumPrincipal.toFixed(2)}`,
          `$${atCur.cumInterest.toFixed(2)}`,
          `-$${atCur.cumFees.toFixed(2)}`
        ];
      });
      renderKpiTable("kpi1Table", ["Loan","Net Earnings","Principal","Interest","Fees"], rows);
    }
    function renderKPI2Table(data){
      const rows = data.map(l => {
        const lastRow = l.earningsSchedule[l.earningsSchedule.length-1];
        return [
          `Loan ${l.id}`,
          `$${lastRow.netEarnings.toFixed(2)}`,
          `$${l.purchasePrice.toFixed(2)}`,
          `${l.termYears} yrs`,
          `${l.graceYears} yrs grace`
        ];
      });
      renderKpiTable("kpi2Table", ["Loan","Projected Net","Principal","Term","Grace"], rows);
    }
    function renderKPI3Table(data){
      const rows = data.map(l => {
        const lastIdx = l.earningsSchedule.length-1;
        const atCur = l.earningsSchedule[Math.min(CURRENT_MONTH-1,lastIdx)] || l.earningsSchedule[lastIdx];
        const avg = CURRENT_MONTH > 0 ? atCur.netEarnings / CURRENT_MONTH : 0;
        return [
          `Loan ${l.id}`,
          `$${avg.toFixed(2)}`,
          `$${atCur.netEarnings.toFixed(2)}`,
          `${CURRENT_MONTH}`,
          `$${l.feePerMonth.toFixed(2)}/mo`
        ];
      });
      renderKpiTable("kpi3Table", ["Loan","Avg / Mo","Net to Date","Months","Fees"], rows);
    }
    function renderKPI4Table(data){
      const rows = data.map(l => {
        const lastIdx = l.earningsSchedule.length-1;
        const atCur = l.earningsSchedule[Math.min(CURRENT_MONTH-1,lastIdx)] || l.earningsSchedule[lastIdx];
        return [
          `Loan ${l.id}`,
          l.purchaseDate,
          `$${l.feePerMonth.toFixed(2)}/mo`,
          `-$${atCur.cumFees.toFixed(2)}`,
          `$${atCur.netEarnings.toFixed(2)}`
        ];
      });
      renderKpiTable("kpi4Table", ["Loan","Purchase","Fee / Mo","Fees to Date","Net to Date"], rows);
    }

    // ======================
    // KPI DRAWER OPEN / CLOSE HANDLERS
    // ======================
    // Logic replicated for KPI drawers; loan drawer behavior remains unchanged.
  </script>
</body>
</html>
